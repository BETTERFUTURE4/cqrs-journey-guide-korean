<div align="center">

#### [목차 바로가기](https://github.com/dhslrl321/cqrs-journey-guide-korean/blob/master/Table%20of%20Contents.md)

</div>

---

# Patterns and Concepts - 2

# 바운디드 컨텍스트 간의 통합

Conference Management 바운디드 컨텍스트는 Order 및 Registration 바운디드 컨텍스트와 통합되어야 한다.

예를 들어서, 비즈니스 고객이 컨퍼런스 관리 바운디드 컨텍스트에서 좌석에 대한 수를 변경하는 경우, 이 변경 사항은 Order 및 Registration 바운디드 컨텍스트에도 전파되어야 한다.

또한 비즈니스 고객은 컨퍼런스 관리 웹사이트의 UI 에서도 세부사항을 확인할 수 있어야 한다.

#### 바운디드 컨텍스트 간의 변경 사항을 전파하는 과정에서 만난 몇가지 이슈와 결정 사항들은 아래 두 개발자의 대화를 통해서 알 수 있다

### 개발자 1

CRUD 스타일의 컨퍼런스 관리 바운디드 컨텍스트와 관련된 두 가지 통합 스토리를 어떻게 구현하는지에 대해 이야기하고싶습니다.

우선, 비즈니스 고객이 이 바운디드 컨텍스트에서 새로운 회의를 만들거나 기존 컨퍼런스에 대해 새로운 좌석 타입을 정의할 때, 주문 및 등록 바운디드 컨텍스트와 같은 다른 바운디드 컨텍스트는 변경 사항에 대해서 알아야 합니다.

둘째, 비즈니스 고객이 좌석 타입의 할당량을 변경할 때, 다른 바운디드 컨텍스트도 이 변화에 대해서 인지하고 있어야 해요

### 개발자 2

그래서 두 경우 모두 컨퍼런스 관리 바운디드 컨텍스트에서 변화를 pushing 하고 있습니다.

### 개발자 1

맞아요

### 개발자 2

설명한 시나리오의 중요한 차이점은 무엇인가요?

### 개발자 1

첫 번째 시나리오에서, 이러한 변화는 상대적으로 드물며 일반적으로 비즈니스 고객이 컨퍼런스를 만들 때 발생합니다.

또한, 이것들은 추가 전용 변경 사항입니다.

우리는 컨퍼런스가 처음 게시된 후 비즈니스 고객이 회의나 좌석 유형을 삭제하는 것을 허용하지 않습니다.

두 번째 시나리오에서는 변경 사항이 더 빈번할 수 있으며 비즈니스 고객이 좌석 할당량을 늘리거나 줄일 수 있습니다.

### 개발자 2

이러한 통합 시나리오에 대해 어떤 구현 접근 방식을 고려하고 있습니까?

### 개발자 1

첫 번째 시나리오에는 2단계 CRUD 스타일의 바운디드 컨텍스트가 있기 때문에 회의와 좌석 유형 정보를 데이터베이스에서 직접 간단한 read 전용 서비스로 구현할 계획이었고 두번째 시나리오는 비즈니스 고객이 좌석 할당량을 업데이트할 때마다 이벤트를 발행할 계획이에요

### 개발자 2

왜 여기서 두 가지 다른 접근법을 사용하나요?
하나의 접근법을 사용하는 것이 더 쉬울 것 같아요.

장기적으로 이벤트를 사용하는 것이 더 유연하죠.

추가 바운디드 컨텍스트에 이 정보가 필요한 경우, 이벤트를 쉽게 구독할 수 있습니다. 이벤트를 사용하면 경계 컨텍스트 사이의 결합이 줄어듭니다.

### 개발자 1

우리가 이벤트를 사용한다면 향후 변화하는 요구 사항에 적응하는 것이 더 쉬울 것이라는 것을 알 수 있죠. 예를 들어, 새로운 바운디드 컨텍스트에 변경을 가한 사람에 대한 정보가 필요한 경우, 이 정보를 이벤트에 추가할 수 있습니다. 기존 바운디드 컨텍스트의 경우, 새 이벤트 형식을 이전 이벤트 형식으로 변환한 어댑터를 추가할 수 있습니다.

### 개발자 2

구독자에게 할당량 변경에 대한 이벤트를 발행한다는 것은 할당량 변경에 대한 요청이라고 볼 수 있습니다.

만약 비즈니스고 객이 좌석 할당량을 50으로 늘렸다고 가정한다면 구독자가 처음에 없어서 전체 업데이트 기록을 수신하지 못하면 어떻게 됩니까?

### 개발자 1

현재 상태의 스냅샷을 사용하는 동기화 메커니즘을 포함해야 할 수도 있습니다. 그러나, 이 경우 이벤트는 단순히 새로운 할당량을 보고할 수 있어요. 필요한 경우, 이벤트는 좌석 할당량의 델타와 절대값을 모두 보고할 수 있죠.

### 개발자 2

일관성을 어떻게 보장할 건가요? 바운디드 컨텍스트가 데이터를 저장소에 보관하고 이벤트 이벤트를 메시지 대기열에 게시하도록 보장해야 합니다.

### 개발자 1

데이터베이스 쓰기 및 대기열 추가 작업을 트랜잭션으로 래핑할 수 있습니다.

### 개발자 2

네트워크의 크기가 증가하고, 응답 시간이 길어지고, 실패 확률이 증가할 때 나중에 문제가 될 두 가지 사항이 있어요.

첫째, 우리의 인프라는 메시지에 Windows Azure Service Bus를 사용합니다. 단일 transac-tion을 사용하여 서비스 버스에서 메시지 전송과 데이터베이스에 대한 쓰기를 결합할 수 없습니다.

둘째, 우리는 장기적으로 항상 문제를 일으키기 때문에 2단계 커밋을 피하려고 노력하고 있습니다.

### 도메인 전문가

우리는 나중에 살펴볼 또 다른 경계 맥락과 비슷한 시나리오를 가지고 있어요. 이 경우, 우리는 경계 컨텍스트를 변경할 수 없습니다; 우리는 더 이상 소스 코드의 최신 복사본이 없습니다.

### 개발자 1

2단계 커밋을 사용하지 않으려면 어떻게 해야 하나요? 그리고 소스 코드에 접근할 수 없어서 변경할 수 없다면 어떻게 해야 하나요?

### 개발자 2

두 경우 모두, 우리는 문제를 해결하기 위해 같은 기술을 사용합니다.

애플리케이션 코드 내에서 이벤트를 게시하는 대신, 데이터베이스를 모니터링하고 데이터베이스의 변경 사항을 감지할 때 이벤트를 보내는 다른 프로세스를 사용할 수 있습니다.

이 솔루션은 소량의 대기 시간을 생성할 수 있지만,

2단계 커밋이 필요하지 않으며 애플리케이션 코드를 변경하지 않고도 구현할 수 있습니다.

---

위 대화와 별개로 또 다른 문제는 통합에 대한 이벤트를 언제 어디서 저장해야 하는지에 관한 것이다.

위에서 논의한 예를 보면, 컨퍼런스 관리 바운디드 컨텍스트는 이벤트를 게시하고 주문 및 등록 바운디드 컨텍스트는 이를 처리하고 read model 을 업데이트하는 데 사용된다.

시스템이 read model 에서 오류가 발생하면 이벤트를 저장하지 않고는 그 읽기 모델 데이터를 다시 만들어내는 방법은 없다.

이러한 통합 이벤트를 저장해야 하는지에 대한 여부는 애플리케이션의 특정 요구사항과 구현에 따라 다를 수 있다.

예를 들어

- write side 는 현재의 예에서와 같이 read side 대신 integration 을 처리할 수 있다.
  - 그런 다음 이벤트는 write side 에서 다른 이벤트로 저장되는 변경 사항의 결과가 된다.
- integration data 는 저장될 필요가 없는 일시적인 데이터일 수도 있다.
- CRUD 스타일 바운디드 컨텍스트의 통합 이벤트는 마지막 이벤트만 필요하도록 상태 데이터를 포함할 수 있다.
  - 예를 들어, 컨퍼런스 관리 바운디드 컨텍스트의 이벤트에 현재 좌석 할당량이 포함된 경우 이전 값에 관심이 없을 수 있다.

---
