<div align="center">

#### [목차 바로가기](https://github.com/dhslrl321/cqrs-journey-guide-korean/blob/master/Table%20of%20Contents.md)

</div>

---

# The Contoso Conference Management System V1 release

이 장에서는 콘소토 컨퍼런스 관리 시스템의 첫 번째 릴리즈를 준비하기 위해서 팀이 내린 결정사항과 변경들에 대해서 이야기한다.

이전 두 장에서 도입한 Order 및 Registration 바운디드 컨텍스트에 대한 리팩토링과 새로운 ConferenceManagement, Payment 바운디드 컨택스트가 추가된다.

#### 여정의 이번 단계에서 팀이 수행한 주요 리팩토링 중 하나는 이벤트 소싱을 Order 와 Registration 바운디드 컨텍스트에 도입했다는 것이다.

CQRS 패턴을 구현함으로써 예상되는 이점 중 하나는 **복잡한 시스템의 관리 및 유지보수에 도움이 될것**이라는 것이다.

CQRS Journey 중에 V1 을 릴리즈하면 이후 릴리즈에서 CQRS 와 Event Sourcing 패턴이 이러한 이점들을 어떻게 제공하는지 확인할 수 있고 나머지 장에서는 V1 출시 이후 어떤 일이 벌어지는지 확인할 수 있다.

이번 장에서는 팀이 웹사이트에 publish 한 UI 에 대해서 설명하고 Task-Based UI 에 대한 이야기도 함께 나눌 것이다.

# Working definitions for this chapter

앞으로 사용할 여러 용어들에 대해서 이야기해보자. 자세한 내용에 대해서는 CQRS Reference 가이드의 4장 "CQRS and ES Deep Dive" 챕터를 참조하라.

### AccessCode

비즈니스 고객이 새로운 컨퍼런스를 만들 때, 시스템은 5자의 액세스 코드를 생성하고 비즈니스 고객에게 이메일로 전송한다.

비즈니스 고객은 컨퍼런스 관리 웹사이트의 이메일 주소와 액세스 코드를 사용해서 나중에 시스템에서 컨퍼런스 디테일 정보들을 검색할 수 있다.

이 시스템은 비즈니스 고객이 서비스 이용을 위해 계정을 가입할 필요가 없고 비밀번호 대신 액세스 코드를 사용한다.

### Event Sourcing

이벤트 소싱은 시스템 내에서 애그리거트의 상태를 영속화하고 다시 로드하는 방법이다.

애그리거트의 상태가 변경될 때마다, 애그리거트는 상태 변경에 대한 이벤트를 발행시킨다. 그 다음 시스템은 이 이벤트를 Event Store 에 저장하고 해당 애그리거트의 인스턴스에서 발생했던 혹은 저장되었던 모든 이벤트를 replay 하여 애그리거트의 상태를 재현할 수 있다.

Event Store 는 시스템에 저장된 데이터의 기록이 된다.

또한 이벤트 소싱을 audit 데이터의 소스로 사용해서 과거 상태를 쿼리하고, 과거 데이터에서 새로운 비즈니스 통찰력을 얻고 디버깅 및 문제 분석을 위한 이벤트 replay 를 독립적으로도 실행시킬 수 있다.

### Eventual Consistency

최종적 일관성은 업데이트된 값에 대한 즉시적인 접근에 의한 일관성을 보장하지 않는 모델이다.

객체의 데이터를 업데이트하고 스토리지에 저장한다면 해당 객체가 항상 동기화가 즉시적으로 된다는 것을 보장하지 않는다. 하지만 시간에 따라서 혹은 어떠한 절차에 따라서 최종적으로는 일관성이 보장된다

단기적으로 일관성을 잃더라도 결국에는 일관성을 유지한다

# User Stories

팀은 이번 여정에서 아래에 나온 user story 들을 구현했다.

## Ubiquitous Language Definition

- **Business Customer**, 비즈니스 고객, 기업 고객
  - 비즈니스 고객은 컨퍼런스 관리 시스템을 사용하여 컨퍼런스를 운영하는 조직을 대표한다.
- **Seat**, 좌석
  - 좌석은 컨퍼런스 공간이나 웰컴세션, 튜토리얼 또는 워크샵과 같은 컨퍼런스의 특정 세션에 참석한다는 것을 의미한다
- **Registrant**, 예약자
  - 예약자는 컨퍼런스에 참석하는 좌석의 구매에 대해 주문하고 결제를 완료 하기 위해 시스템과 상호 작용하는 사람이다. 등록자는 Order 와 Registration 을 한다

## Conference Management Bounded Context 유저스토리

비즈니스 고객은 새로운 컨퍼런스를 만들고 관리할 수 있다.

비즈니스 고객이 새로운 컨퍼런스를 만든 후, 이메일 주소와 컨퍼런스 locator access code 를 입력하여 컨퍼런스에 대한 세부 사항에 접근할 수 있다.

비즈니스 고객이 컨퍼런스를 생성할 때 시스템은 액세스 코드를 생성한다.

#### 비즈니스 고객은 다음과 같은 정보들을 컨퍼런스에 추가할 수 있다.

- name, description, slug
- 시작일과 끝나는 시각
- 컨퍼런스에서 사용 가능한 여러 종류의 좌석 타입

또한 비즈니스 고객은 컨퍼런스에 대한 공개여부를 설정하여 웹사이트에서 보일지 보이지 않을지 설정할 수 있다.

비즈니스 고객은 컨퍼런스 관리 웹사이트를 사용해서 주문 및 참석자의 목록에 대해서 확인할 수 있다.

## Ordering and Registration bounded context 유저스토리

예약자가 주문을 생성할 때, 주문을 완전히 끝마치지 못할 수도 있다.

예를 들어, 예약자는 다음과 같이 예약할 수 있다

- 전체 컨퍼런스 좌석 5개
- 웰컴 세션 5개
- 워크숍 3개

하지만 시스템상에는 다음 좌석만 남아있다

- 전체 컨퍼런스 좌석 5개
- 웰컴 세션 1개
- 워크숍 3개

이 상황에서 시스템은 예약자에게 이러한 정보를 제공하고 각 좌석에 대해서 수량을 다시 조절해달라는 요청을 할 수도 있다.

예약자가 각 좌석 유형의 수량을 선택한 후, 시스템은 주문의 총 가격을 계산하고, 예약자는 온라인 결제 서비스를 사용해서 해당 좌석에 대해서 실제 결제를 수행할 수 있다.

콘토소는 고객을 대신해서 결제를 처리하지 않는다. 각 비즈니스는 온라인 결제 시스템을 사용할 수 있도록 하는 메커니즘이 필요하다.

후반부에서 콘토소는 비즈니스 고객이 invoice system 을 컨퍼런스 관리 시스템과 통합할 수 있도록 지원할 것이다.

> 이 버전에서 실제 결제는 일어나지 않을 것이다

예약자가 회의에서 좌석을 구매한 후, 좌석에 참여자를 할당할 수도 있다. 시스템은 이를 위해 각 참석자의 이름과 연락처 정보를 저장한다

# 아키텍처

아래의 그림은 V1 릴리즈에서 콘토소 컨퍼런스 관리 시스템의 주요 아키텍처에 대해서 보여준다.

애플리케이션은 두 개의 웹사이트와 세 개의 바운디드 컨텍스트로 구성되어있다.

인프라는 Windows Azure SQL DB 인스턴스 그리고 event store 및 메시징 인프라가 포함된다

<img width="1144" alt="image" src="https://user-images.githubusercontent.com/48385288/199699030-344da229-55e5-4682-87e5-07f7730fd21b.png">

아래의 표는 위 그림에서 표현된 각각의 컴포넌트가 주고받는 메시지를 정리한 표다

<img width="991" alt="image" src="https://user-images.githubusercontent.com/48385288/199699416-634d925d-ecf8-47d0-b647-460582279483.png">

<img width="1005" alt="image" src="https://user-images.githubusercontent.com/48385288/199699465-3cadf41f-9d2b-4228-a2a9-a40a3dc85ed0.png">

다음 목록은 Contoso 컨퍼런스 관리 시스템의 메시지 명명 규칙을 간략하게 설명한다

- 모든 evnet 는 과거형으로 명명한다
- 모든 command 는 명령형으로 명명한다
- 모든 DTO 는 명사다

이 애플리케이션은 Windows Azure 에 배포하도록 설계되었다.

이번 Journey 에서 애플리케이션은 ASP.NET MVC 웹 애플리케이션을 퐇마하는 두 개의 역할과 메시지 핸들러와 도메인 객체를 포함하는 워커로 구성된다.

애플리케이션은 write side 와 read side 모두에서 데이터 저장을 위해 SQL Database 인스턴스를 사용한다.

Order 및 Registration 바운디드 컨텍스트는 이제 event store 를 사용해서 write side 의 state 를 저장한다.

event store 는 이벤트를 저장하기 위해서 windows Azure 의 Table Manager 를 사용하고 메시징 인프라는 Azure Service Bus 를 사용한다.

# Conference Management Bounded Context

컨퍼런스 관리 바운디드 컨텍스트는 간단한 2-tier, CRUD 스타일의 웹 애플리케이션이다.

이 바운디드 컨텍스트는 CQRS 패턴을 구현하는 다른 바운디드 컨텍스트와 integrated 되어야 한다

---
