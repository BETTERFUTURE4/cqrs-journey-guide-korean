<div align="center">

#### [목차 바로가기](https://github.com/dhslrl321/cqrs-journey-korean-ver/blob/master/Table%20of%20Contents.mdwn)

</div>

---

# Messaging 과 CQRS

CQRS 와 이벤트소싱은 두가지 유형의 메시지를 사용한다.

#### command 와 event

일반적으로 CQRS 패턴을 구현하는 시스템은 대규모 분산 시스템이므로 producer/consumer 및 publisher/subscriber 간의 메시지 전송에 신뢰할 수 있는 메시징 인프라가 필요하다.

단일 수신자가 있는 **command** 의 경우 일반적으로 queue topology 를 사용한다. 그리고 **event** 의 경우 여러 수신자가 있기 때문에 pub/sub 형태의 topology 를 사용한다.

이 가이드와 함께 제공되는 RI 는 메시징을 위해 windows azure service bus 를 사용한다. 7장 "Technology used in Reference Implementation" 에서는 이에 대한 추가 설명을 제공한다.

## messaging 을 도입할 때 필요한 고려사항

messaging 을 사용할 때, 몇가지 고려사항들이 존재한다.

이번 장에서는 Event 와 Command 를 사용하여 CQRS 를 구현하기 위해 가장 중요한 몇가지 이슈들에 대해서 이야기한다.

- message 중복
- message 유실
- message 순서 보장
- 처리되지 않은 메시지

### message 중복

메시징 인프라나 메시지를 수신하는 코드의 오류로 인해서 메시지는 수신자에게 여러번 전달될 수 있다.

이러한 문제를 해결할 수 있는 두가지 접근법이 존재한다.

- **메시지를 멱등하게 설계한다.**
  - 메시지를 멱등하게 설계해서 중복 메시지가 들어오더라도 데이터의 일관성이 깨지지 않도록 설계하는 방법이다.
- **중복 메시지를 찾는 로직을 구현한다.**
  - 몇몇의 메시징 인프라는 중복 검출에 대한 설정 전략을 지원하기 때문에 직접 구현하지 않고 이러한 인프라의 도움을 받을 수도 있다.

멱등 (idempotency) 에 대해서 더욱 자세히 알고싶다면 Pat Helland. 의“[Idempotence Is Not a Medical Condition](https://queue.acm.org/detail.cfm?id=2187821)” 에 대해서 확인하는 것도 추천한다

### message 유실

메시지 유실에 대한 문제도 처리해야 한다.

많은 메시징 인프라는 메시지가 손실되지 않고 수신자에게 적어도 한번 (At least once) 전달된다는 보증을 제공한다.

메시지가 손실되었을 때를 감지하기 위해 구현할 수 있는 대안에 대한 전략에 대해서는 발신자에게 수신에 대한 승인을 구하거나 수신자가 message 를 받지 못하였는지 알 수 있도록 message 에 sequence 번호를 할당하는 handshake process 가 필요하다

### message 순서 보장

메시징 인프라는 발신자가 메시지를 보낸 순서와 다른 순서로 수신자에게 메시지를 전달할 수 있다.

일부 시나리오에서 메시지가 수신되는 순서는 중요하지 않을 수 있지만 또 다른 시나리오에서는 중요할 수 있다.

메시지 순서가 중요하다면, 일부 메시징 인프라 구조는 순서를 보장해주는 제품들이 있을 것이다.

그렇지 않다면 전송되는 메시지에 sequence 번호를 할당하여 주문 외 메시지를 감지할 수 있다.

메시지를 올바른 순서로 정렬하기 까지 받은 메시지를 따로 저장하는 메커니즘을 process manager 에 해당 로직을 구현할 수도 있다.

특정 그룹 내에서 메시지를 정렬해야 하는 경우, 관련 메시지를 단일 배치로 보낼 수도 있으니 참고하라

### 처리되지 않은 메시지

클라이언트는 대기열에서 메시지를 검색한 다음 메시지를 처리하는 동안 실패할 수 있는데, 제대로 처리되지 않은 상태에서 클라이언트가 메시지를 다시 수신한다면 메시지가 손실된다.

일부 메시징 인프라를 사용하면 메시지 처리가 실패하였을 때 롤백할 수 있는 분산 트랜잭션의 일부로 인프라에서 메시지 읽기를 수행할 수 있다.

또한 특정 메시지 인프라에서 제공하는 또 다른 접근 방식을 메시지 읽기를 two-phase operation 으로 처리하는 것이다.

1. 먼저 메시지를 lock 한 뒤 읽는다.
2. message handling 이 끝나면 완료로 표시하고, 대기열에서 제거된다.

메시지가 완료로 표시되지 않으면, 메시지의 locking 시작이 초과되고 다시 읽을 수 있게 된다.

---
