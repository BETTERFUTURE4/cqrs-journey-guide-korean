<div align="center">

#### [목차 바로가기](https://github.com/dhslrl321/cqrs-journey-korean-ver/blob/master/Table%20of%20Contents.mdwn)

</div>

---

# Process Manager

이 섹션에서 Process Manager 라는 용어에 대해 간략하게 설명한다.

ProcessManager 를 설명하기 전에 CQRS 가 일반적으로 메시지를 사용해서 애그리거트와 바운디드 컨텍스트 간에 통신하는 방법에 대한 간략한 요약을 해보겠다.

## Message 와 CQRS

CQRS 를 구현할 때, 일반적으로 시스템 내에서 데이터를 교환하기 위한 두가지 유형의 메시지가 존재한다. command 와 event

#### command 는 필수적이다.

command 를 통해 시스템이 작업을 수행하도록 요청하는 것이다. 예를 들어 "Conference X 에서 두 장소를 예약하라" 또는 "연사 Y 를 Z 호실에 할당하라" 와 같은 의미를 가지고 있고 command 는 단일 수신자에 의해 한번만 처리된다.

#### Event 는 notification 이다

이벤트는 관련 이해 관게자들에게 무슨 일이 일어났음을 알린다. 예를들어 "지불이 거부됨", "좌석이 생성됨" 과 같은 과거 시제를 사용하며 이벤트는 한번 게시되면 여러 구독자에게 전달된다.

일반적으로, command 는 바운디드 컨텍스트 내에서 전송되지만 이벤트는 발생된 곳과 동일한 바운디드 컨텍스트 또는 다른 바운디드 컨텍스트에서 구독자를 가질 수 있게 된다.

이 Reference Guide 의 "CQRS 및 ES 딥 다이브" 장에서 이벤트와 커맨드를 설명한다.

## Process Manager 는 무엇인가

애그리거트와 바운디드 컨텍스트를 사용하여 모델링한 복잡한 시스템에는 여러 애그리거트를 포함하는 일부 비즈니스 프로세스 또는 여러 바운디드 컨텍스트의 여러 애그리거트가 포함될 수 있다.

이러한 비즈니스에서 참여하는 애그리거트에 의해 다른 유형의 여러 메시지가 발생된다.

예를 들어, 컨퍼런스 관리 시스템에서 컨퍼런스에서 좌석을 구매하는 비즈니스에는 Order, Reservation, Payment 애그리거트가 포함될 수 있다.

그들은 모두 고객이 구매를 완료할 수 있도록 협력해야 한다.

아래의 그림은 이러한 애그리거트가 주문을 성공적으로 수행할 수 있도록 하는 과정을 보여준다.

집계와 경계 컨텍스트를 사용하여 모델링한 복잡한 시스템에는 여러 집계를 포함하는 일부 비즈니스 프로세스 또는 여러 경계 컨텍스트에서 여러 집계가 포함될 수 있습니다. 이러한 비즈니스 프로세스에서 참여 집계에 의해 다른 유형의 여러 메시지가 교환됩니다. 예를 들어, 회의 관리 시스템에서 회의에서 좌석을 구매하는 비즈니스 프로세스에는 주문 집계, 예약 집계 및 지불 집계가 포함될 수 있습니다. 그들은 모두 고객이 구매를 완료할 수 있도록 협력해야 한다.

<img width="1378" alt="image" src="https://user-images.githubusercontent.com/48385288/197342255-9865b2ea-b95d-49de-a7be-fa56628126c5.png">

그림 1에 보이는 바와 같이 각 애그리거트는 프로세스의 다음 단계를 수행하는 애그리거크에 적절한 command 를 보낸다.

- 주문 애그리거트는 먼저 고객이 요청한 좌석을 예약하기 위해 예약 애그리거트에 `MakeReservation` 이라는 command 를 보낸다.
- 좌석이 예약된 후, 예약 애그리거트는 주문 애그리거트에게 이 사실을 알리기 위해 좌석 예약 Event 를 발행산다.
- 주문 애그리거트는 지불 애그리거트에 `MakePayment` command 를 보낸다.
- 결제가 성공하면 주문 애그리거트에서 `OrderConfirmed` 이벤트를 발행한다.
- 예약 애그리거트는 해당 이벤트를 수신해서 주문이 완료되었음을 사용자에게 알린다.

<img width="1363" alt="image" src="https://user-images.githubusercontent.com/48385288/197342569-d0173a23-d4db-44bf-a241-e5c5178a7123.png">

그림 2에 보여지는 예는 그림 1에 표시된 것과 동일한 비즈니스 프로세스를 보여주지만, 이번에는 Process Manager 를 사용한다.

이제 각 애그리거트 메시지를 다른 애그리거트로 직접 보내는 대신, 메시지는 프로세스 매니저가 중재한다.

이것은 프로세스를 더 복잡하게 만드는것 처럼 보이지만, 몇가지 장점이 있다.

1. 애그리거트는 더이상 특정 작업의 후속 작업을 몰라도 된다. 단지 Process Manager 에게 보고하면 된다.
2. 메시지 흐름 정의는 이제 애그리거트 전체에 흩어지기보다 단일 장소인 Process Manager 로 통한다.

그림 1과 2에 표시된 것과 같은 간단한 비즈니스 프로세스에서 이러한 이점은 미미하나 6개의 애그리거트와 수십 개의 메시지를 포함하는 비즈니스 프로세스가 있다면 이러한 이점은 분명해진다.

이것은 비즈니스 프로세스가 자주 변경되는 시스템일 경우 더욱 장점이 빛을 발한다.

그림 3에서 이 점을 설명하기 위해 우리는 위 프로세스에서 예약의 대기자 리스트에 대해서 한번 가정해보자.

고객이 요청한 좌석 중 일부를 예약할 수 없는 경우, 시스템은 좌석 요청을 대기자 명단에 추가한다. 이를 변경하기 위해서 우리는 `SeatsNotReserved` 이벤트를 발행하기 위해 예약 애그러거트를 수정하여 얼마나 많은 좌석을 예약할 수 있는지 보고하는 `SeatsReserved` 이벤트 외에도 예약할 수 없는 좌석의 수를 보고한다.

그런 다음 ProcessManager 는 WaitList 애그리거트로 command 를 보내 요청의 완료되지 않은 부분을 대기자 명단에 올릴 수 있다.

<img width="1165" alt="image" src="https://user-images.githubusercontent.com/48385288/197342996-0688ef9a-f0d3-4c68-ba0b-4475c316fa9c.png">

Process Manager 는 비즈니스 로직을 수행하지 않아야 한다.

단지 메시지만 라우팅되며, 어떤 경우에는 메시지 컨버팅이 이루어질 수 있다.

예를 들어 `SeatsNotReserved` 이벤트를 수신하면 `AddToWaitList` command 를 보내는 것과 같다.

# 언제 Process Manager 를 사용해야 하는가?

ProcessManager 를 사용해야 하는 두가지 이유가 있다.

- 바운디드 컨텍스트가 많은 수의 이벤트와 command 를 사용할 때
  - 애그리거트 간 이벤트 소비 지점이 관리하기 힘들다
- 바운디드 컨텍스트에서 메시지 라우팅을 더 쉽게 수정하고 싶을 때
  - 프로세스 매니저는 라우팅이 정의된 단일 장소만을 제공하기 때문에 유용하다

# 언제 Process Manager 를 사용하면 안되는가?

- 바운디드 컨텍스트의 수가 적고 메시지가 적을 때
- 도메인에서 비즈니스 로직을 구현하기 위해 Process Manager 를 사용해서는 안된다.
  - 비즈니스 로직은 애그리거트에 속한다.

# Sagas 와 CQRS

비록 우리가 이 장의 앞에서 정의한 대로 Process Manager 라는 용어를 사용하기로 했지만 Saga 는 여전히 일부 바운디드 컨텍스트에서 CQRS 패턴을 구현하는 시스템에서 역할을 수행할 수 있다.

일반적으로, Process Manager 가 바운디드 컨텍스트 내에서 애그리거트 간의 메시지를 라우팅하며 여러 바운디드 컨텍스트에 걸쳐 실행되는 장기 트랜잭션을 찾을 수 있다.

---
